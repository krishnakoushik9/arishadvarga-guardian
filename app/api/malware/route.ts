import { NextRequest, NextResponse } from 'next/server';
import { exec } from 'child_process';
import { promisify } from 'util';
import os from 'os';

const execAsync = promisify(exec);

// Helper to get OS specific command
// Helper to get OS specific command
function getClamCommand(action: 'version' | 'scan', scanType?: 'quick' | 'user' | 'system' | 'custom', customPath?: string): string {
    const platform = os.platform();
    const isWindows = platform === 'win32';

    if (action === 'version') {
        return 'clamscan --version';
    }

    if (action === 'scan') {
        let targetPath = '';

        switch (scanType) {
            case 'user':
                targetPath = os.homedir();
                break;
            case 'system':
                targetPath = isWindows ? 'C:\\Windows\\System32' : '/usr/bin';
                break;
            case 'custom':
                if (customPath && !customPath.includes('..') && !customPath.includes(';')) {
                    targetPath = customPath;
                } else {
                    targetPath = isWindows ? 'C:\\Windows\\Temp' : '/tmp';
                }
                break;
            case 'quick':
            default:
                targetPath = isWindows ? 'C:\\Windows\\Temp' : '/tmp';
                break;
        }

        return `clamscan -r "${targetPath}" --no-summary`;
    }

    return '';
}

export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        const { action, path } = body;

        if (action === 'check') {
            try {
                const cmd = getClamCommand('version');
                const { stdout } = await execAsync(cmd);
                return NextResponse.json({
                    installed: true,
                    version: stdout.trim(),
                    platform: os.platform()
                });
            } catch (e) {
                return NextResponse.json({
                    installed: false,
                    platform: os.platform()
                });
            }
        }

        if (action === 'scan') {
            const { scanType, customPath } = body;
            const cmd = getClamCommand('scan', scanType, customPath);

            try {
                // clamscan returns exit code 1 if virus found, so exec might throw.
                // We need to handle stdout even if it "fails" with code 1.
                const { stdout, stderr } = await execAsync(cmd);
                return NextResponse.json({
                    success: true,
                    output: stdout,
                    threatsFound: false
                });
            } catch (error: any) {
                // Exit code 1 means virus found (usually)
                if (error.code === 1) {
                    return NextResponse.json({
                        success: true,
                        output: error.stdout, // stdout still contains the list of infected files
                        threatsFound: true
                    });
                }

                return NextResponse.json({
                    success: false,
                    error: error.message || 'Scan failed',
                    output: error.stdout,
                    stderr: error.stderr
                });
            }
        }

        return NextResponse.json({ error: 'Invalid action' }, { status: 400 });

    } catch (error) {
        console.error('Malware API Error:', error);
        return NextResponse.json(
            { error: 'Internal server error' },
            { status: 500 }
        );
    }
}
