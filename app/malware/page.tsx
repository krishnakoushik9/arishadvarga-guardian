'use client';

import React, { useState } from 'react';
import { Skull, Scan, Shield, AlertTriangle, FileWarning, Trash2, Eye, Play, CheckCircle, Loader2, Terminal, Copy, Crosshair, HardDrive, User, Zap } from 'lucide-react';
import styles from './page.module.css';

const quarantinedFiles = [
    { name: 'shell.aspx', path: 'C:\\inetpub\\wwwroot\\', type: 'Web Shell', family: 'Generic.WebShell', mitre: 'T1505.003', severity: 'critical' },
    { name: 'mimikatz.exe', path: 'C:\\Windows\\Temp\\', type: 'Credential Theft', family: 'HackTool.Mimikatz', mitre: 'T1003', severity: 'critical' },
    { name: 'payload.ps1', path: 'C:\\Users\\admin\\', type: 'PowerShell Dropper', family: 'Trojan.PowerShell', mitre: 'T1059.001', severity: 'high' },
    { name: 'nc.exe', path: 'C:\\Windows\\Temp\\', type: 'Network Tool', family: 'HackTool.Netcat', mitre: 'T1095', severity: 'medium' },
];

export default function Malware() {
    const [isScanning, setIsScanning] = useState(false);
    const [clamInstalled, setClamInstalled] = useState<boolean | null>(null);
    const [clamVersion, setClamVersion] = useState('');
    const [platform, setPlatform] = useState('');
    const [scanOutput, setScanOutput] = useState('');
    const [infectedFiles, setInfectedFiles] = useState<any[]>([]); // Use a proper type if possible
    const [scanStats, setScanStats] = useState({ total: 0, infected: 0, time: 0 });
    const [scanType, setScanType] = useState<'quick' | 'user' | 'system'>('quick');

    // Check installation on mount
    React.useEffect(() => {
        checkClamAV();
    }, []);

    const checkClamAV = async () => {
        try {
            const res = await fetch('/api/malware', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'check' }),
            });
            const data = await res.json();
            setClamInstalled(data.installed);
            if (data.installed) setClamVersion(data.version);
            setPlatform(data.platform);
        } catch (e) {
            console.error('Failed to check ClamAV', e);
            setClamInstalled(false);
        }
    };

    const handleScan = async () => {
        setIsScanning(true);
        setScanOutput('');
        setInfectedFiles([]);
        const startTime = Date.now();

        try {
            const res = await fetch('/api/malware', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'scan', scanType }),
            });
            const data = await res.json();

            setScanOutput(data.output || '');

            // Simple parsing logic for ClamAV output
            // Example line: /tmp/eicar.com: Eicar-Test-Signature FOUND
            const lines = (data.output || '').split('\n');
            const found = lines
                .filter((l: string) => l.includes(' FOUND') && !l.includes('Empty file'))
                .map((l: string) => {
                    const [path, threat] = l.split(': ');
                    return {
                        name: path.split('/').pop() || path,
                        path: path,
                        family: threat.replace(' FOUND', ''),
                        severity: 'critical',
                        type: 'Malware',
                        mitre: 'T1204' // Generic execution
                    };
                });

            setInfectedFiles(found);
            setScanStats({
                total: lines.length, // Rough estimate of scanned items based on output lines if verbose, but standard output is summary
                infected: found.length,
                time: (Date.now() - startTime) / 1000
            });

        } catch (e) {
            setScanOutput(`Error executing scan: ${e}`);
        } finally {
            setIsScanning(false);
        }
    };

    if (clamInstalled === false) {
        return (
            <div className={styles.page}>
                <div className={styles.header}>
                    <h1><Skull size={28} /> Antivirus & Malware Triage</h1>
                    <p>ClamAV integration required</p>
                </div>

                <div className={styles.installGuide}>
                    <div className={styles.warningCard}>
                        <AlertTriangle size={48} className={styles.warningIcon} />
                        <h2>ClamAV Not Found</h2>
                        <p>To use the malware scanning features, you must install ClamAV on your system.</p>

                        <div className={styles.codeBlock}>
                            <div className={styles.codeHeader}>
                                <Terminal size={14} />
                                {platform === 'win32' ? 'Windows (PowerShell)' : 'Linux (Terminal)'}
                            </div>
                            <code onClick={() => navigator.clipboard.writeText(platform === 'win32' ? 'winget install ClamAV' : 'sudo apt-get install clamav')}>
                                {platform === 'win32' ? 'winget install ClamAV' : 'sudo apt-get install clamav'}
                            </code>
                            <div className={styles.copyHint}><Copy size={12} /> Click to copy</div>
                        </div>

                        <button className={styles.refreshBtn} onClick={checkClamAV}>
                            <Scan size={16} /> Check Again
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className={styles.page}>
            <div className={styles.header}>
                <h1><Skull size={28} /> Antivirus & Malware Triage</h1>
                <p>ClamAV integration active â€¢ {clamVersion}</p>
            </div>

            <div className={styles.scanSection}>
                <div className={styles.scanCard}>
                    <div className={styles.scanHeader}>
                        <Scan size={24} />
                        <div>
                            <h3>ClamAV Scanner</h3>
                            <p>Target: {scanType.toUpperCase()} Scan Mode</p>
                        </div>
                    </div>

                    {/* Scan Type Selector */}
                    <div className={styles.scanSelector}>
                        <button
                            className={`${styles.typeBtn} ${scanType === 'quick' ? styles.active : ''}`}
                            onClick={() => setScanType('quick')}
                            disabled={isScanning}
                        >
                            <Zap size={16} /> Quick Scan
                        </button>
                        <button
                            className={`${styles.typeBtn} ${scanType === 'user' ? styles.active : ''}`}
                            onClick={() => setScanType('user')}
                            disabled={isScanning}
                        >
                            <User size={16} /> User Scan
                        </button>
                        <button
                            className={`${styles.typeBtn} ${scanType === 'system' ? styles.active : ''}`}
                            onClick={() => setScanType('system')}
                            disabled={isScanning}
                        >
                            <HardDrive size={16} /> System Scan
                        </button>
                    </div>

                    {!isScanning && scanStats.time > 0 && (
                        <div className={styles.scanStats}>
                            <div className={styles.statItem}><span className={styles.statValue}>{scanStats.total}</span><span>lines output</span></div>
                            <div className={styles.statItem}><span className={`${styles.statValue} ${scanStats.infected > 0 ? styles.danger : ''}`}>{scanStats.infected}</span><span>Threats Found</span></div>
                            <div className={styles.statItem}><span className={styles.statValue}>{scanStats.time.toFixed(1)}s</span><span>Duration</span></div>
                        </div>
                    )}

                    <div className={styles.scanActionArea}>
                        <button className={styles.scanBtn} onClick={handleScan} disabled={isScanning}>
                            {isScanning ? <><Loader2 size={16} className={styles.spinner} /> Scanning...</> : <><Play size={16} /> Start Scan</>}
                        </button>
                    </div>

                    {/* Radar Animation Overlay */}
                    {isScanning && (
                        <div className={styles.radarContainer}>
                            <div className={styles.radarSweep}></div>
                            <div className={styles.radarGrid}></div>
                            <div className={styles.radarStatus}>SCANNING SECTORS...</div>
                        </div>
                    )}

                    {/* Live Output Log */}
                    {(isScanning || scanOutput) && (
                        <div className={styles.terminalOutput}>
                            <div className={styles.outputHeader}>
                                <Terminal size={12} /> Scanner Output
                            </div>
                            <pre>{scanOutput || 'Initializing scan engine...'}</pre>
                        </div>
                    )}
                </div>
            </div>

            {infectedFiles.length > 0 && (
                <div className={styles.quarantineSection}>
                    <h2><FileWarning size={20} /> Threats Detected ({infectedFiles.length} items)</h2>
                    <div className={styles.quarantineList}>
                        {infectedFiles.map((file, idx) => (
                            <div key={idx} className={`${styles.quarantineItem} ${styles[file.severity]}`}>
                                <div className={styles.fileInfo}>
                                    <span className={styles.fileName}>{file.name}</span>
                                    <span className={styles.filePath}>{file.path}</span>
                                </div>
                                <div className={styles.fileMeta}>
                                    <span className={styles.fileFamily}>{file.family}</span>
                                    <span className={styles.fileType}>{file.type}</span>
                                </div>
                                <div className={styles.mitreBadge}>{file.mitre}</div>
                                <span className={`${styles.severityBadge} ${styles[file.severity]}`}>{file.severity}</span>
                                <div className={styles.fileActions}>
                                    <button title="Analyze"><Eye size={14} /></button>
                                    <button title="Delete"><Trash2 size={14} /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Fallback to mock quarantine if no real scan threats yet */}
            {infectedFiles.length === 0 && !isScanning && !scanOutput && (
                <div className={styles.quarantineSection}>
                    <p className={styles.emptyState}>No active threats detected in this session. Run a scan to check for malware.</p>
                </div>
            )}

            <div className={styles.cleanupSection}>
                <h2><Shield size={20} /> AI Cleanup Recommendations</h2>
                <div className={styles.cleanupContent}>
                    <div className={styles.recommendationCard}>
                        <AlertTriangle size={20} />
                        <div>
                            <h4>Remove Malicious Files</h4>
                            <p>Delete all quarantined items after forensic collection is complete.</p>
                        </div>
                        <button><CheckCircle size={14} /> Execute</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
